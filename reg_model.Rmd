---
title: "Регрессионая модель"
author: "Ядонист Роман"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

#### Пстроение модели

Загрузим данные
```{r echo=FALSE, include=FALSE}
setwd('/Users/yadonistroman/Documents/GitHub/trustus-r/data')
library(tidyverse)
library(readxl)
library(stargazer)
library(lmtest)
library(sandwich)
library(pROC)
df <- read_excel('total.xlsx')
```

Добавим столбец с временем года
```{r echo=FALSE, include=FALSE}
season_v <- rep(c('зима', 'весна', 'лето', 'осень'), each=3)
season_v <- season_v[2:12]
season_v <- c(season_v, season_v[1])
season_v <- rep(season_v, 83)

df <- df %>% add_column('Сезон' = season_v, .before = 'Квартал')
```

1. Поcтроим регрессионную модель, которая позволяет выяснить:
 - каким образом потребительская активность зависит от средней заработной платы в регионе, 
числа активных абонентов беспроводного наземного фиксированного доступа к сети Интернет и
уровня безработицы населения.
```{r echo=FALSE}
# для нашей цели линейной регрессии будет достачно

mod_reg_pa <- lm(data = df, Индекс.ПА ~ `Среднемесячная з.п.` + 
                   `Число абонентов` + `Уровень безработицы` + Сезон)
summary(mod_reg_pa)
```
```{r echo=FALSE, include=FALSE}
stargazer(mod_reg_pa, type = 'text')
```

 - каким образом доля безналичных платежей в торговом обороте зависит от средней заработной 
платы в регионе, числа активных абонентов беспроводного наземного фиксированного доступа к 
сети Интернет и уровня безработицы населения.
```{r echo=FALSE}
# построим линейную регрессию

mod_reg_bp <- lm(data = df, Индекс.БП ~ `Среднемесячная з.п.` + `Число абонентов` + `Уровень безработицы` + Сезон)
summary(mod_reg_bp)
```
```{r echo=FALSE, include=FALSE}
stargazer(mod_reg_bp, type = 'text')
```

2. Добавим столбец в датафрейм из 0 и 1. Где за 1 будем считать, что доля онлайн-заявок больше 50%. И он
будет показывать склонность населения к онлайн сервисам банка.
```{r echo=FALSE, include=FALSE}
df <- df %>% mutate(`Онлайн-заявки dummy` = ifelse(`Онлайн-заявки` > `Офлайн-заявки`, 1, 0))
```

3. Добавим столец в датафрейм также из 0 и 1. Где за 1 бедем считать количество ипотечных сделок в регионах
больше 500. Этот столбец будет показывать склонность населиня оформлять ипотеку.
```{r echo=FALSE, include=FALSE}
# поработаем со шкалой данных столбца 'всего ипотечных сделолк'
# разделим на начальное и конечное значение и возьмем только начальное значение
# и сравним с порогом в 500 сделок на регион

df_ipot <- df %>% select(Регион, `Всего ипотечных сделок`)
df_ipot$`Всего ипотечных сделок` <- gsub(' ', '', df_ipot$`Всего ипотечных сделок`)
df_ipot$`Всего ипотечных сделок` <- gsub('>', '', df_ipot$`Всего ипотечных сделок`)
ipot_list <- strsplit(df_ipot$`Всего ипотечных сделок`, '-')

ipot_v <- c()
for (i in ipot_list) {
  ipot_v <- c(ipot_v, i[1])
}

df_ipot$`Всего ипотечных сделок` <- as.numeric(ipot_v)
df_ipot <- df_ipot %>% mutate(`Ипотечые сделки dummy` = ifelse(`Всего ипотечных сделок` >= 500, 1, 0))
df$`Ипотечые сделки dummy` <- df_ipot$`Ипотечые сделки dummy`
```

4. Построим регрессионную модель, которая позволит выяснить, каким образом склонность населения предпочитать 
онлайн-услуги банка зависит от средней заработной платы в регионе, числа активных абонентов беспроводного 
наземного фиксированного доступа к сети Интернет и уровня безработицы населения.
```{r echo=FALSE}
# для предсказания бинарной целевой переменной воспользуемся логистической регрессией
mod_lreg_online <- glm(data = df, `Онлайн-заявки dummy` ~ `Среднемесячная з.п.` + 
                         `Число абонентов` + 
                         `Уровень безработицы` +
                         Сезон, 
                       family = 'binomial')
summary(mod_lreg_online)
exp(coef(mod_lreg_online))
```
```{r echo=FALSE, include=FALSE}
stargazer(mod_lreg_online, type = 'text')
```

5. Построим регрессионную модель, которая позволит выяснить, каким образом склонность населения оформлять 
ипотеку зависит от средней заработной платы в регионе, числа активных абонентов беспроводного наземного 
фиксированного доступа к сети Интернет и уровня безработицы населения.
```{r echo=FALSE}
# воспользуемся логистической регрессией
mod_lreg_ipot <- glm(data = df, `Ипотечые сделки dummy` ~ `Среднемесячная з.п.` + 
                         `Число абонентов` + 
                         `Уровень безработицы` +
                         Сезон, 
                       family = 'binomial')
summary(mod_lreg_ipot)
exp(coef(mod_lreg_ipot))
```
```{r echo=FALSE, include=FALSE}
stargazer(mod_lreg_ipot, type = 'text')
```

#### Выводы
1. В первом задание для предсказания индекса потребеительской активности и индекса безналичных платежей
использовали линейную регрессию (так как нужно было предсказать число). Для обоих моделей были 
использаваны следующие независимые переменные: средняя заработанная плата в регионе, число абонентов доступа к
сети интернет и уровень безработицы населения. Так же построеная модель зависима от времени года.

В итоге для индекса потребительской активности получили зависимоть от следующих переменных: уровень 
безработицы населения и от всех ремен года (за исходное время года было взята весна), p-value у этих 
коэффициентов меньше адекватного уровня значимости. Определили R-squared и он равен 0.4, уровень прогностический
силы модели ниже среднего.
Зависимости получились следующие:
 
 - при увеличении уровня безработицы на 1, индекс потребительской активности падает на 0.25 при равных прочих;
 - при смене времени года:
   на зиму индекс потребительской активности увеличивается на 8.48 при равных прочих относительно весны;
   на лето индекс потребительской активности увеличивается на 13.24 при равных прочих относительно весны;
   на осень индекс потребительской активности увеличивается на 13.12 при равных прочих относительно весны.
   
Для индекса безналичных платежей получили зависимость от следующих переменных: средняя заработанная плата
в регионе, число абонентов доступа к сети интернет, уровень безработицы населения. Так же была определена 
зависимость изменения от перехода с весны на осень, у остальных времен года (зима и лето) p-value больше 
адекватного уровня значимости, зависимости от перехода на зиму или лето нет. Определили R-squared = 0.55 
уровень прогностический силы модели чуть выше среднего.
Зависимости получились следующие:

 - при увеличении заработанной платы на 1 рубль, индекс безналичных платежей увеличивается на 1.370e-04 при 
 равных прочих;
 - при увеличение числа абонентов на 1, индекс безналичных платежей увеличивается на 8.419e-05 при равных прочих;
 - при увеличение уровня безработицы на 1, индекс безналичных платежей падает на 1.35 при равных прочих;
 - только при смене на осень, индекс безналичных платежей на 2.16 при равных прочих относительно весны.
 
 2. Для следущего задания необходимо сначала привести целывые переменные к данным состоящими из 1 и 0. В 
первой модели такая целевая переменная это онлайн-заявки на получения кредита, где 1 означает, что была оформалена онлайн-заявка и 0 соответственно офлайн. Во второй модели целевая переменная будет количество взятых ипотек, 
где 1 будет означать, что оформлено более 500 ипотек в регионе в месяц и 0 соответственно от 500 и ниже. 
Для этого выделим начальное количество оформленных ипотек и переведм в количественную шкалу. Далее сравним с 
количеством в 500 оформленых ипотек. Единица будет показывать регион где активно оформляют ипотки.
Построим регрессионные модели для определения какие независимые переменные и насколько влияют на то, что бы 
человек оформлял кредит онлайн и производил сделки по ипотеке. Соотвественно независимыми переменными в обоих
случаях будут: средняя заработанная плата в регионе, число абонентов доступа к сети интернеи и уровень безработицы 
населения. Так же построеная модель была зависима от времени года. Для модели используем логистическую регрессию
в обоих случаях, так как нам нужно определить бинарную целевую переменную.

В первом случае для модели по оформлению онлайн-заявок получили зависимость от всех используемых переменных, 
включая времена года. p-value меньше адекватного уровня значимости.
Зависимости получились следующие:

 - при увеличении заработанной платы на 1 рубль, вероятность оформления онлай-заявки на кредит увеличиться
в 1.00005 при равных прочих;
 - при увеличение числа абонентов на 1, вероятность оформления онлай-заявки на кредит увеличиться
в 1.00003 при равных прочих;
 - при увеличение уровня безработицы на 1, вероятность оформления онлай-заявки на кредит увеличиться
в 1.09 при равных прочих;
 - при смене времени года:
   на зиму вероятность оформления онлай-заявки на кредит уменьшиться в 0.29 при равных прочих относительно весны;
   на лето вероятность оформления онлай-заявки на кредит уменьшиться в 0.25 при равных прочих относительно весны;
   на осень вероятность оформления онлай-заявки на кредит уменьшиться в 0.54 при равных прочих относительно весны.
   
Модель для активности по ипотечным сделкам зависит от: средняй заработанной плата в регионе, число абонентов доступа к
сети интернет и уровень безработицы населения. Так же построеная модель зависима от прехода на лето и осень
относительно весны. p-value меньше адекватного уровня значимости.
Зависсимости получились следующие:

 - при увеличении заработанной платы на 1 рубль, вероятность оформления онлай-заявки на кредит уменьшилась
в 0.9999 при равных прочих;
 - при увеличение числа абонентов на 1, вероятность оформления онлай-заявки на кредит увеличиться
в 1.00008 при равных прочих;
 - при увеличение уровня безработицы на 1, вероятность оформления онлай-заявки на кредит уменьшилось
в 0.73 при равных прочих;
 - при смене времени года:
   на лето вероятность оформления онлай-заявки на кредит увеличилась в 2.49 при равных прочих относительно весны;
   на осень вероятность оформления онлай-заявки на кредит увеличилась в 6.17 при равных прочих относительно весны.

#### Проверка качества регрессионых моделий
1. Проврка качества линейной регрессии.
Проверку качества модели будет проводит по трем признакам:
 - проверка на сильную зависимость между собой независимых пременных. Из вывода характеристики модели можно увидеть,
что сила моели не слишком высокая а признаки явлются значимыми. Это говорит о том мультиколлиниарности скорее всего 
нет. Проверим еще одним способом, для этого построим корреляционную матрицу для этих признаков.
```{r echo=FALSE}
# создадим датафрейм из нужных нам признаков
small <- df[, c(6, 7, 8)]
cor(small)
```
В выводе корреляционной матрицы сильных зависимостей между признаками нет, что говорит об отсутствии мультиколлиниарности.

 - проверка как распределены остатки, нет ли зависимостей (гетероскедастичность). Построим график рассеивания для 
остатков и придсказаных моделью результатов.
```{r echo=FALSE}
# добавим в датафрейм данные с остатками и предсказанными значениями
df$fitted_pa <- mod_reg_pa$fitted.values
df$residuals_pa <- mod_reg_pa$residuals

df$fitted_bp <- mod_reg_bp$fitted.values
df$residuals_bp <- mod_reg_bp$residuals

ggplot(data = df, aes(x = fitted_pa, y = residuals_pa)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = 'red') +
  theme_bw() +
  ggtitle('Индекс покупательской активности') +
  ylab('Остатки') +
  xlab('Предсказанные значения')

ggplot(data = df, aes(x = fitted_bp, y = residuals_bp)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = 'red') +
  theme_bw() +
  ggtitle('Индекс безналичных платежей') +
  ylab('Остатки') +
  xlab('Предсказанные значения')
```

Из графиков видно, что остатки распределены не случайно и есть зависимость в обоих случах. Значит есть проблема гетероскедастичности.

```{r echo=FALSE}
coeftest(mod_reg_pa, vcov = vcovHC(mod_reg_pa, type = 'HC0'))
coeftest(mod_reg_bp, vcov = vcovHC(mod_reg_bp, type = 'HC0'))
mod_reg_pa <- lm(data = df, Индекс.ПА ~ `Среднемесячная з.п.` + 
                   `Число абонентов` + `Уровень безработицы` + Сезон)
summary(mod_reg_pa)

mod_reg_bp <- lm(data = df, Индекс.БП ~ `Среднемесячная з.п.` + `Число абонентов` + `Уровень безработицы` + Сезон)
summary(mod_reg_bp)
```

 - проверка на наличие влиятельных наблюдений. Влиятельные наблюдения можно выявить графически. Для
этого построим графики.

```{r echo=FALSE}
plot(mod_reg_pa, 5)
plot(mod_reg_bp, 5)
```

Из графиков видно, что влиятельных значений нет.

2. Проверка качества логистической регрессии.
Проверим качества моделей с помощью ROC-AUC.
 - проверка качества модели по предсказанию доли онлайн-заявок
```{r echo=FALSE, include=FALSE}
roc_online <- roc(df$`Онлайн-заявки dummy` ~ mod_lreg_online$fitted.values)
```
```{r echo=FALSE}
roc_online$auc
```


 - проверка качества модели по предсказанию активности оформления ипотечных сделок
```{r echo=FALSE, include=FALSE}
roc_ipot <- roc(df$`Ипотечые сделки dummy` ~ mod_lreg_ipot$fitted.values)
```
```{r echo=FALSE}
roc_ipot$auc
```

Судя по площади под кривой, мы получили в обоих случаях чорошую прогоностическую силу модели.












