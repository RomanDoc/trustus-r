---
title: "Разведывательный анализ данных"
auther: 'Ядонист Роман'
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

## Выбор регионов, лидирующих по потребительской активности, безналичным платежам и внутреннему туризму

Загрузка данных

```{r echo=FALSE, include=FALSE}
setwd('/Users/yadonistroman/Documents/GitHub/trustus-r/data')
library(tidyverse)
library(readxl)
df <- read_excel('total.xlsx')
```

1. Выведем описательные статистики для данных из СберИндекс

```{r}
summary(df$Индекс.БП)
summary(df$Индекс.ПА)
summary(df$Количество.ВТ)
```
Согласно описательным статистикам видно, что:
 - индекс безналичных платежей в среднем по стране равен, чуть больше 50% (52%),
но в некоторых регионах он возрастает до 70% и может упасть до 10%. Это значит, что
в некоторых регионах люди очень мало используют безналичный способ оплаты (возможно 
такой способ оплаты недоступен), а в некоторых очень активно, но в среднем по стране 
чуть больше половины людей производит оплату безналичным способом.
 - Индекс потребительской активности в среднем равен 65%, значит что потребители в 
среднем покупают товаров на 65% от самого активного дня в году (30 декабря), что думаю
неплохо. Также есть месяца когда индекс потребительской активности возрастает до 88%
и падает до 34%.
 - Что касается количества внутренних туристов, то среднее количество равно примерно 
минус 8%, знак минус говорит о том что в среднем количество туристов уменьшилось по сравнению
с предыдущим годом.

2. Построим графики для показателей СберИндекс в среднем по России, по месяцам.
Для этого создадим дополнительный датафрейм с данными по месяцам в среднем по России.

```{r echo=FALSE}
df_for_graf <- df %>% group_by(Месяц) %>% summarise(Индекс.БП = round(mean(Индекс.БП), 1),
                                                    Индекс.ПА = round(mean(Индекс.ПА), 1),
                                                    Количество.ВТ = round(mean(Количество.ВТ), 1))

df_for_graf$Месяц <- factor(df_for_graf$Месяц, levels = c('январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                                                          'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'))

ggplot(data = df_for_graf, aes(x = Месяц, y = Индекс.БП)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(0, 100) +
  theme_bw() +
  labs(title = 'График доли безналичных платежей',
       x = 'Месяц',
       y = 'Доля безналичных платежей (%)')

ggplot(data = df_for_graf, aes(x = Месяц, y = Индекс.ПА)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(0, 100) +
  theme_bw() +
  labs(title = 'График покупательской активности',
       x = 'Месяц',
       y = 'Покупательская активность (%)')

ggplot(data = df_for_graf, aes(x = Месяц, y = Количество.ВТ)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(-50, 50) +
  theme_bw() +
  labs(title = 'График внутрених туристов',
       x = 'Месяц',
       y = 'Текучусть внутрених туристов')
```
 - График доли безналичных платежей в среднем по России показывает, что люди каждый 
месяц оплачивают безналичным способом чуть больше половины всех покупок.
 - График покупательской способности показывает, что у людей покупательская активность 
падает в апреле и мая. Наилучшие месяцы по покупательской активности это начиная с июля и 
почти до конца года.
 - Что касается графика движения внутренних туристов, то очень сильно просел этот показатель 
в апреле и мая по сравнению с предыдущим годом, также спад наблюдается и на конец года. Но 
начало года показало увеличения количества внутрених туристов. Так же конец лето и начало 
осень идет увеличения притока внутренних туристов.

3 .Построим графики boxplot для показателей СберИндекс.

```{r echo=FALSE}
ggplot(data = df, aes(y = Индекс.БП)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot индекс безналичных платежей') +
  ylab('Индекс безналичных платежей (%)')


ggplot(data = df, aes(y = Индекс.ПА)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot индекс пакупательской активности') +
  ylab('Индекс пакупательноц активности (%)')

ggplot(data = df, aes(y = Количество.ВТ)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot внутрених туристов') +
  ylab('Показатель текучести внутрених туристов')
```

4. Выведим нетипичные значения в отдельные датафреймы, соответственно по показателям СберИндекса.

```{r echo=FALSE}
extra <- function(data) {
  iqr <- IQR(data)
  q1 <- quantile(data, 0.25)
  q3 <- quantile(data, 0.75)
  lower_b <- q1 - 1.5 * iqr
  upper_b <- q3 + 1.5 * iqr
  return(c(lower_b, upper_b))
}

test_pa <- extra(df$Индекс.ПА)
df_test_pa <- df[df$Индекс.ПА < test_pa[1] | df$Индекс.ПА > test_pa[2], ]
df_test_pa 

test_bp <- extra(df$Индекс.БП)
df_test_bp <- df[df$Индекс.БП < test_bp[1] | df$Индекс.БП > test_bp[2], ]
df_test_bp

test_vt <- extra(df$Количество.ВТ)
df_test_vt <- df[df$Количество.ВТ < test_vt[1] | df$Количество.ВТ > test_vt[2], ]
df_test_vt
```
После анализа датафрейма с нетипичными значениями можно предположить следующее:
 - В датафрейме с индексом безналичных платежей, видим, что к ним относятся большинство 
регионов Кавказа (причем в выборку попали регионы полностью по всем месяцам) и показатель 
всегда ниже первого квантиля. На мой взгляд не стоит относить эти значения к выбросам и
удалять их, по следующим причинам: либо в этих регионах недостаточно развита система безналичных
платежей, либо это связано с менталитетом местного населения, предпочитающих расплачиваться
живыми деньгами.
 - В датафрейме с индексом покупательской активности, значения которые меньше первого квантиля 
приходятся на апрель и май. Если мы посмотрим на график покупательской активности, то увидим,
что в эти месяца идет спад этого показателя. Можно предположить, что значения не являются 
выбросами удалять их также не стоит, а обусловлено спадом покупательной активности. То же 
самое и со значениями превышающие третий квантиль, выпадают на сентябрь месяц, что подтверждает
график покупательской активности.
 - Значения в датафрейме количества внутренних туристов, тоже не стоит относить к выбросам, так как 
значения больше третьего квантиля и они приходятся на те месяца когда идет рост движения внутренних
туристов, что подтверждает график количества внутренних туристов.
Если говорить в целом нетипичные значения отличаются примерно на 1-5%, на мой взгляд не стоит
удалять их. Они не повлияют на модель, а из-за их удаления можем потерять много полезной информации.


5. Выберем топ 30 регионов лидирующих по индексу покупательской способности
```{r echo=FALSE}
df_top_pa <- df %>% 
  group_by(Регион) %>% 
  summarise(`Индекс.ПА` = round(mean(Индекс.ПА), 1))

df_top_pa <- arrange(df_top_pa, desc(Индекс.ПА)) %>% top_n(30)
df_top_pa
```

6. Выберем топ 30 регионов лидирующих по индексу безналичных платежей.
```{r echo=FALSE}
df_top_bp <- df %>% 
  group_by(Регион) %>% 
  summarise(`Индекс.БП` = round(mean(Индекс.БП), 1))

df_top_bp <- arrange(df_top_bp, desc(Индекс.БП)) %>% top_n(30)
df_top_bp
```

7. Выберем те регионы которые лидируют по индексу покупательской способности
и индексу безналичных платежей.
```{r echo=FALSE}
df_top_bp_pa <- inner_join(df_top_bp, df_top_pa, by = 'Регион')
df_top_bp_pa
```

8. Выберем строки из датафрейма df которые соответствуют выборки лидирующих регионов
```{r echo=FALSE}
df_top <- df[df$Регион %in% df_top_bp_pa$Регион, ]
df_top
```

9,10. Отфильтруем те регионы в которых приток внутренних туристов есть хотя бы в пяти месяцах
```{r echo=FALSE, interval=FALSE}
df_top <- df_top[df_top$Количество.ВТ > 0, ]
# согласно датафрейму df_top пропишем вектор в котором приток туристов виден хотябы в пяти месяцах
target_v <- c('калининградская область', 'камчатский край', 'кировская область', 'нижегородская область')
df_final <- df[df$Регион %in% target_v, ]
df_final
```

11. Итог: 
В результате проведенных исследование по покупательской способности, показателя объема безналичных платежей
и притока внутренних туристов, можно выделить четыре лидирующих по этим показателям региона:
- Калининградская область,
- Камчатский край,
- Кировская область,
- Нижегородская область.
Показания вышеупомянутых показателей следующие:
Показатель покупательской способности.
В целом показатель покупательской способности показывает одинаковое поведение на протяжении всего года 
для всех регионов. Неплоха покупательская активность в начале года в среднем 65-70%, далее идет резкий 
спад в апреле и мая до 45-50% и постепенный подъем. Максимум наблюдаем в сентябре месяце 75-85% и до 
конца года держится на высоком уровне.
Показатель объема безналичных платежей.
Объем безналичных платежей на протяжение всего года колеблется примерно в пределах 55-60%. Без 
каких-либо скачков для всех регионов. То есть чуть больше половины людей пользуется услугами безналичных
платежей.
Количество внутренних туристов.
Количество туристов по сравнению с прошлым годом сильно колеблется на протяжение всего года, но тенденция по 
всем регионом совпадает. Год начинается с увеличение потока внутренних туристов в пределах 5-25%. потом идет на
спад и достигает своего минимум апрель - июнь, спад может достигать до 80%. И конец лета начало весны 
наблюдаем повышения потока туристов до 65%. И далее до конца года спад. Можно говорить что указанные регионы 
в январе, феврале, марте, августе и сентябре посещают наибольшее количество туристов по сравнению с предыдущим
годом.

## Поиск взаимосвязи

1. Построим график зависимости индекса безналичных платежей от количества внутренних туристов
```{r echo=FALSE}
ggplot(data = df_final, aes(x = Количество.ВТ, y = Индекс.ПА)) + 
  geom_point() +
  theme_bw() +
  stat_ellipse(color = 'red') +
  labs(title = 'График зависмости объема безналичных платежей от\n количества внутрених туристов',
       x = 'Количество внутрених туристов (%)',
       y = 'Индекс безналичных платежей (%)')
```

Из графика видно, что связь имеется и она прямопропорциональная, то есть при увеличение количества внутренних туристов
идет увеличение объема безналичных платежей. 

2. Посмотрим на коэффициент корреляции Пирсона и проверим значим он или нет.
Уровень значимости возьмем 5%. И сформулируем нулевую гипотезу, что коэффициент Пирсона равен 0, связи в данных нет. 
Альтернативная гипотеза будет следующая: связь между данных есть и эта связь значима.
```{r echo=FALSE}
cor.test(df_final$Количество.ВТ, df_final$Индекс.ПА)
```

Коэффициент корреляции Пирсона равен 0.69. В свою очередь p-value = 4.53е-08, это очень маленькое значение, оно
намного меньше 5%. Значит вероятность допустить ошибку отвергнув нулевую гипотезу меньше 5%. Можем отвергнуть нулевую 
гипотезу. Между данными есть связь и она значима, к тому же коэффициент корреляции положителен это значит, что связь
прямопропорциональная.

3. Предположение Михаила верно, в регионах которые посещают больше туристов доля безналичных платежей выше. Это видно 
из графика рассеивания и корреляционного теста.

4. Проверим предположение, что чем больше люди берут кредиты, то тем больше число ипотечных сделок.
Для начала переведем данные в количественную шкалу и создадим отдельный датафрейм. Возьмем только начальные значения 
и переведем их в числовые данные. 
```{r echo=FALSE}
df_ipot_cred <- df_final %>% select(Регион, `Всего одобренных заявок`, `Всего ипотечных сделок`)
df_ipot_cred$`Всего одобренных заявок` <- gsub(' ', '', df_ipot_cred$`Всего одобренных заявок`)
df_ipot_cred$`Всего ипотечных сделок` <- gsub(' ', '', df_ipot_cred$`Всего ипотечных сделок`)
df_ipot_cred$`Всего ипотечных сделок`  <- gsub('>', '', df_ipot_cred$`Всего ипотечных сделок`)
cred_list <- strsplit(df_ipot_cred$`Всего одобренных заявок`, '-')
ipot_list <- strsplit(df_ipot_cred$`Всего ипотечных сделок`, '-')

cred_v <- c()
for (i in cred_list) {
  cred_v <- c(cred_v, i[1])
}
df_ipot_cred$`Всего одобренных заявок` <- as.numeric(cred_v)

ipot_v <- c()
for (i in ipot_list) {
  ipot_v <- c(ipot_v, i[1])
}
df_ipot_cred$`Всего ипотечных сделок` <- as.numeric(ipot_v)

cor.test(df_ipot_cred$`Всего одобренных заявок`, df_ipot_cred$`Всего ипотечных сделок`)
```

5. Проверим предположение, есть ли связь между долей безналичных платежей и количеством поданых заявок онлайн.
```{r echo=FALSE}
cor.test(df_final$Индекс.БП, df_final$`Онлайн-заявки`)
```

6. Выводы по пункту 4 и 5.
 - связь между количеством кредитов и числом ипотечных сделок.
Сформулируем нулевую гипотезу: связи между варметрами нет, коэффициент корреляции не значим.
Альтернативная гипотеза: связь между параметрами есть. 
Уровень значимости 5%.
В результате теста получаем, что коэффициент корреляции Пирсана равен 0.75 - связь сильная и положительная (связь прямопроаорциональная). p-value равна почти нулю, значит нулевую гипотезу можно отбросить, то есть связь есть. При 
увеличение количества потребительских кредитов, идет увеличение количество ипотечных сделок.
 - связь между индексом безналичных платежей и количеством онлайн заявок на кредит.
Нулевая гипотезе так же как и в предыдущем примере, связи нет между параметрами.
Альтернативная гипотеза, связь есть. Уровень значимости возьмем 5%.
После проведения теста получаем коэффициент корреляции Пирсона равный 0.33 - связь слабая и положительная (связь 
прямопропорциональная). p-value равен 0.021, всеровно меньше 5%, это говорит о том, что нулевую гипотеза можно 
отбросить, связь есть хотя слабая.

7. Добавим в датафрайм столбец Сезон.
```{r echo=FALSE}
season_v <- rep(c('зима', 'весна', 'лето', 'осень'), each=3)
season_v <- season_v[2:12]
season_v <- c(season_v, season_v[1])
season_v <- rep(season_v, 4)

df_final <- df_final %>% add_column('Сезон' = season_v, .before = 'Квартал')
df_final$Сезон <- factor(df_final$Сезон, levels = c('зима', 'весна', 'лето', 'осень'))
```

8. Построим столбчатую диаграмму для каждой категории ипотечных сделок в зависимости от времени года.
```{r echo=FALSE}
ggplot(data = df_final, aes(x = `Всего ипотечных сделок`, fill = Сезон)) + 
  geom_bar() + 
  theme_bw() +
  facet_wrap(~Сезон) +
  ggtitle('График количества ипотечных сделок \nпо временам года') +
  xlab('Категории ипотечных сделок в месяц') +
  ylab('Количество категорий')
```
Из графика видно, что минимальное количество ипотечных сделок приходиться на зиму, а максимальное
на осень.

9. Построим график boxplot для распределения доли онлайн заявок в зависимости от времени года.
```{r echo=FALSE}
ggplot(data = df_final, aes(y = `Онлайн-заявки`)) + 
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~Сезон) +
  ggtitle('График распределния онлайн заявок на кредит \nпо временам года') +
  ylab('Доля онлайн-заявок на кредит')
```

Что бы понять из данного графика в какое время года совершается наибольшее количество онлайн-заявок
необходимо сравнить их медианы. Наибольшая медиана приходиться на осень и минимальная на зиму. Таким 
образом наибольшие количество онлайн заявок приходиться на осень, а минимальное на зиму. Увеличения 
онлайн заявок осенью, объясняется тем, что люди набирают кредитов в преддверии нового года (на подарки 
или, что-то для себя, дома) сервис сейчас очень распространен и пользоваться ими очень удобно. Касательно 
зимнего периода, предположу, что согласно графику движения туристов, в зимний период было увеличения туристов 
соответственно большинство людей поехали отдыхать. Оформление туристических путевок происходит в офисах
компаний, где очень часто находятся представители банков, соответственно оформление кредита происходит
в офлайн режиме.

10. Проверим гипотезу, есть ли связь между временем года и долей онлайн-заявок на кредит. Так как
в сравниваемых данных присутствуют категориальные данные воспользуемся тестом хи-квадрат. Сформулируем
нулевую гипотезу: зависимости между онлайн-заявками на кредит и временем года нет. Альтернативная гипотеза: 
зависимость есть. Уровень значимости 5%.
```{r echo=FALSE}
chisq.test(df_final$`Онлайн-заявки`, df_final$Сезон)
```

По результатом теста получили p-value = 0.21, что больше уровня значимости (5%), значит вероятность 
допустить ошибку отвергнув нулевую гипотезу более уровня значимости. Соответственно нет оснований 
отвергнуть нулевую гипотезу и зависимости между временем года и долей онлайн-заявками на кредит нет.

11. Построим график boxplot для распределения доли ипотечных сделок на вторичке в зависимости от сезона
```{r echo=FALSE}
ggplot(data = df_final, aes(y = `Доля сделок, вторичка`)) + 
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~Сезон) +
  ggtitle('График распределния доли ипотечных сделок \nна вторичке по временам года') +
  ylab('Доля ипотечных сделок, вторичка')
```

Что бы понять в какое время года ипотечных сделок на вторичное жилье было совершено больше на графике boxplot, 
необходимо сравнить их медианы. Согласно графику, время года в котором было совершено наибольшее количество сделок
это зима и весна 2020 года, а минимальное это лето. Возможно это связанно с тем, что в летний период было сдано
много нового жилья и люди предпочли брать ипотеки на новое жилье.

12. Проверим гипотезу, есть ли связь между временем года и долей ипотечных сделок на вторичное жилье. Также 
воспользуемся тестом хи-квадрат. Сформулируем нулевую и альтернативную гипотезу. Нулевая гипотеза: связи между
долей ипотечный сделок на вторичном рынке и временем года нет. Альтернативная гтпотеза: связь есть. 
Уровень значимости 5%.
```{r echo=FALSE}
chisq.test(df_final$`Доля сделок, вторичка`, df_final$Сезон)
```

По результатам теста p-value = 0.27. Это значение больше уровня значимости. Вероятность допустить ошибку отвергнув
нулевую гипотезу более уровня значимости. Основания отвергнуть нулевую гипотезу нет, соответственно связи между
долей ипотечных сделок на вторичке и временем года нет.

13. Подводя итоги о проделанных изысканий относительно взятых людьми кредитов и ипотеки за 2020 год относительно 
сезона, можно сделать следующие выводы:
 - максимальное количество ипотечных сделок приходилось на осень, а минимальное на зиму.
 - из них максимальное количество сделок на вторичном рынке было сделано зимой и весной.
 - что касается кредитов, то максимальное количество онлайн заявок на кредит за 2020 год было сделано осенью, 
 а минимальное зимой.
 - все эти данные актуальны на 2020 год, проведенные тесты показали, что каких-то взаимосвязей между ними и 
 временем года нет. Возможно, что бы определить взаимосвязи необходимо больше данных (например взять набор данных
 за несколько лет) и произвести дополнительные изыскания и тесты.
 
```{r echo=FALSE, include=FALSE}
# сохраним финальный датафрейм в файл
library(openxlsx)

setwd('/Users/yadonistroman/Documents/GitHub/trustus-r/data')

write.xlsx(df_final, 'final.xlsx')
```
 






















