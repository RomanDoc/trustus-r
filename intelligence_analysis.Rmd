---
title: "Разведовательный анализ данных"
auther: 'Ядонист Роман'
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

Загрузка данных

```{r echo=FALSE, include=FALSE}
setwd('/Users/yadonistroman/Documents/GitHub/trustus-r/data')
library(tidyverse)
library(readxl)
df <- read_excel('total.xlsx')
```

Выведим описательные статистики для данных из СберИндекс

```{r}
summary(df$Индекс.БП)
summary(df$Индекс.ПА)
summary(df$Количество.ВТ)
```
Согласно описптельным статистикам видно, что:
1. индекс безналичных платежей в среднем по строне равен, чуть больше 50% (52%),
но в некоторых регеонах он возрастает до 70% и может упасть до 10%. Это значит, что
в некоторых регионах люди очень мало используют безналичный способ оплаты (возможно 
такой способ оплаты недоступен), а в некоторых очень активно, но в среднем по стране 
чуть больше половины людей производит оплату безналичным способом.
2. Индекс потребительской активности всреднем равен 65%, значит что потребители в 
среднем покупают товаров на 65% от самого активного дня в году (30 декабря), что думаю
неплохо. Также есть месеца когда индекс потребительской активности возрастает до 88%
и падает до 34%.
3. Что касается количества внутренних туристов, то среднее количество равно примерно 
минус 8%, знак минус говорит о том что в среднм количество туристов уменьшилось по сравнению
с предыдущим годом.

Построим графики для показателей СберИндекс в среднем по России, по месяцам.
Для этого создадим дополнительный датафрейм с данными по месяцам в среднем по России.

```{r echo=FALSE}
df_for_graf <- df %>% group_by(Месяц) %>% summarise(Индекс.БП = round(mean(Индекс.БП), 1),
                                                    Индекс.ПА = round(mean(Индекс.ПА), 1),
                                                    Количество.ВТ = round(mean(Количество.ВТ), 1))

df_for_graf$Месяц <- factor(df_for_graf$Месяц, levels = c('январь', 'февраль', 'март', 'апрель', 'май', 'июнь', 
                                                          'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'))

ggplot(data = df_for_graf, aes(x = Месяц, y = Индекс.БП)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(0, 100) +
  theme_bw() +
  labs(title = 'График доли безналичных платежей',
       x = 'Месяц',
       y = 'Доля безналичных платежей (%)')

ggplot(data = df_for_graf, aes(x = Месяц, y = Индекс.ПА)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(0, 100) +
  theme_bw() +
  labs(title = 'График покупательской активности',
       x = 'Месяц',
       y = 'Покупательская активность (%)')

ggplot(data = df_for_graf, aes(x = Месяц, y = Количество.ВТ)) + 
  geom_col(fill = 'skyblue',
           col = 'black') +
  ylim(-50, 50) +
  theme_bw() +
  labs(title = 'График внутрених туристов',
       x = 'Месяц',
       y = 'Текучусть внутрених туристов')
```
1. График доли безналичных платежей в среднем по России показывает, что люди каждый 
месяц оплачивают безналичным способом чуть больше половины всех покупок.
2. График покупательской способности показывает, что у людей покупательская активность 
падает в апреле и мая. Наилучшие месяцы по пукапательской активности это начиная с июля и 
почти до конца года.
3. Что касается графика движения внутрених туристов, то очень сильно просел этот показатель 
в апреле и мая по сравнению с предыдущим годом, также спад наблюдается и на конец года. Но 
начало года показало увеличения количества внутрених туристов. Так же конец лето и начало 
осень идет увеличения притока внутрених туристов.

Построим графики boxplot для показателей СберИндекс.

```{r echo=FALSE}
ggplot(data = df, aes(y = Индекс.БП)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot индекс безналичных платежей') +
  ylab('Индекс безналичных платежей (%)')


ggplot(data = df, aes(y = Индекс.ПА)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot индекс пакупательской активности') +
  ylab('Индекс пакупательноц активности (%)')

ggplot(data = df, aes(y = Количество.ВТ)) + 
  geom_boxplot() + 
  facet_wrap(~Месяц) +
  theme_bw() +
  ggtitle('Графики boxplot внутрених туристов') +
  ylab('Показатель текучести внутрених туристов')
```

Выведим нетипичные значения в отдельные датафреймы, соответственно по показателям СберИндекса.

```{r echo=FALSE, include=FALSE}
extra <- function(data) {
  iqr <- IQR(data)
  q1 <- quantile(data, 0.25)
  q3 <- quantile(data, 0.75)
  lower_b <- q1 - 1.5 * iqr
  upper_b <- q3 + 1.5 * iqr
  return(c(lower_b, upper_b))
}

test_pa <- extra(df$Индекс.ПА)
df_test_pa <- df[df$Индекс.ПА < test_pa[1] | df$Индекс.ПА > test_pa[2], ]

test_bp <- extra(df$Индекс.БП)
df_test_bp <- df[df$Индекс.БП < test_bp[1] | df$Индекс.БП > test_bp[2], ]

test_vt <- extra(df$Количество.ВТ)
df_test_vt <- df[df$Количество.ВТ < test_vt[1] | df$Количество.ВТ > test_vt[2], ]
```
После анализа датафрейма с нетепичными значениями можно предположить сдледующее:
1. В датафрейме с индексом безналичных платежей, видим, что к ним относяться большенство 
регионов кавказа (причем в выборку попали регионы полностью по всем месяцам) и показатель 
всегдла ниже перевого квантиля. На мой взгляд не стоит относить эти значения к выбросам и
удалять их, по следующим причинам: либо в этих регионах недостаточно развита система безналичных
платежей, либо это связано с менталитетом местного населения, предпочитающих расплачиваться
живыми деньгами.
2. В датафрейме с индексом покупательской активности, значения которые меньше первого квантиля 
приходяться на апрель и май. Если мы посмотрим на график покупательской активности, то увидим,
что в эти месяца идет спад этого показателя. Можно предположить, что значения неявляются 
выбрасами удалять их также нестоит, а обусловленно спадом покупательной активности. То же 
самое и со значениями превышающие третий квантиль, выподают на сентябрь месяц, что подтверждает
график покупательской активности.
3. Значения в датафрейме количества внутрених туристов, тоже нестоит относить к выбросам, так как 
занчения больше третьего квантиля и они приходяться на те месяца когда идет рост движения внутрених
туристов, что подтверждает график количества внутрених туристов.
Если говорить в целов нетипичные значения отличаются примерно на 1-5%, на мой взгляд нестоит
удалять их. Они неповлияют на модель, а из-за их удаления можем потерять много полезной информации.


Выберем топ 30 регионов ледирующих по индексу покупательской спосбности.
```{r echo=FALSE, include=FALSE}
df_top_pa <- df %>% 
  group_by(Регион) %>% 
  summarise(`Индекс.ПА` = round(mean(Индекс.ПА), 1))

df_top_pa <- arrange(df_top_pa, desc(Индекс.ПА)) %>% top_n(30)
```

Выберем топ 30 регионов лидирующих по индексу безналичных платежей.
```{r echo=FALSE, include=FALSE}
df_top_bp <- df %>% 
  group_by(Регион) %>% 
  summarise(`Индекс.БП` = round(mean(Индекс.БП), 1))

df_top_bp <- arrange(df_top_bp, desc(Индекс.БП)) %>% top_n(30)
```

Выберем те регионы которые лидируют по индексу покупательской способности
и индексу безналичных платежей.
```{r echo=FALSE, include=FALSE}
df_top_bp_pa <- inner_join(df_top_bp, df_top_pa, by = 'Регион')
```

Выберем строки из датафрейма df которые соответствуют выборки лидирующих регионов
```{r echo=FALSE, include=FALSE}
df_top <- df[df$Регион %in% df_top_bp_pa$Регион, ]
```

Отфильтруем те регионы в которых приток внутрених туристов есть хотябы в пяти месяцах
```{r echo=FALSE, interval=FALSE}
df_top <- df_top[df_top$Количество.ВТ > 0, ]
# согласно датафрейму df_top пропишем вектор в котором приток туристов виден хотябы в пяти месяцах
target_v <- c('калининградская область', 'камчатский край', 'кировская область', 'нижегородская область')
df_final <- df[df$Регион %in% target_v, ]
```

Итог: 
В результате проведенных иследование по пакупательской способности, показателя объема безналичных платежей
и притока внутрених туристов, можно выделить четыре ледирующих по этим показателям региона:
- Калининградская область,
- Камчатский край,
- Кировская область,
- Нижегородская область.
Показания вышеупамянутых показателей следующие:
Показатель покупательской способности.
В целом показатель покупателской способности показывает одинаковеое поведение на протежении всего года 
для всех регионов. Неплоха покупательская активность в начале года в срденем 65-70%, далее идет резкий 
спад в апреле и мая до 45-50% и постепеный подъем. Максимум наблюдаем в сентябре месяце 75-85% и до 
конца года держится на высоком уровне.
Показатель объема безналичных платежей.
Объем безналичных платежей на протежение всего года колеблиться примерно в пределах 55-60%. Без 
каких-либо скачков для всех регионов. Тоесть чуть больше половины людей пользуется услугами безналичных
платежей.
Количество вутрених туристов.
Количество туристов по сравнению с прошлым годом сильно колеблится на протежение всего года, но тенденция по 
всем регионом совпадает. Год начинается с увеличение потока внутрених туристов в пределах 5-25%. потом идет на
спад и достигает своего миниму апрельмай - июнь, спад может достигать до 80%. И конец лета начало весны 
наблюдаем повышения потока туристов до 65%. И далее до конца года спад. Можно говорить что указанные регионы 
в январе, феврале, марте, августе и сентябре посещают наибольшее количество туристов по сравнению с предыдущим
годом.

Построим график зависимости индекса безналичных платежей от колличества внутрених туристов
```{r echo=FALSE}
ggplot(data = df_final, aes(x = Количество.ВТ, y = Индекс.ПА)) + 
  geom_point() +
  theme_bw() +
  stat_ellipse(color = 'red') +
  labs(title = 'График зависмости объема безналичных платежей от\n количества внутрених туристов',
       x = 'Количество внутрених туристов (%)',
       y = 'Индекс безналичных платежей (%)')
```
Из графика видно, что связь имеется и она прямая, тоесть при увеличение количества внутрених туристов
идет увеличение объема безналичных платежей. Проверим











